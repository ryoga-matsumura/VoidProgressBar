<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>è™šç„¡ã®é€²æ—ãƒãƒ¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rer="icon" th:href="@{/favicon.ico}">
  <style>
    body { background-color: #f8f9fa; font-family: 'Helvetica Neue', Arial, sans-serif; }
    .log-container {
        background-color: #1e1e1e;
        color: #00ff00;
        font-family: 'Courier New', monospace;favicon.ico
        height: 300px;
        overflow-y: scroll;
        border-radius: 8px;
        padding: 15px;
        box-shadow: inset 0 0 10px #000;
    }
  </style>
</head>
<body class="container py-5">

<div class="text-center mb-5">
  <h1 class="display-4 fw-bold">â³ è™šç„¡ã®é€²æ—ãƒãƒ¼</h1>
  <p class="lead text-muted">é«˜åº¦ãªæŠ€è¡“ã§ã€Œä½•ã‚‚ã—ãªã„ã€ã‚’å®Ÿè¡Œä¸­...</p>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body text-center">
    <div class="progress mb-4" style="height: 30px;">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
           role="progressbar" style="width: 0%">0%</div>
    </div>

    <button id="startBtn" class="btn btn-primary btn-lg px-5" onclick="startVoid()">
      ğŸš€ å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹
    </button>
  </div>
</div>

<div class="log-container shadow" id="logArea">
  <div>[SYSTEM] Ready...</div>
</div>

<script>
  function startVoid() {
      const btn = document.getElementById('startBtn');
      const progressBar = document.getElementById('progressBar');
      const logArea = document.getElementById('logArea');

      // 1. ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
      btn.disabled = true;
      btn.innerText = "å®Ÿè¡Œä¸­...";
      progressBar.style.width = '0%';
      progressBar.innerText = '0%';
      progressBar.classList.remove('bg-success');
      progressBar.classList.add('bg-info');

      // 2. ã‚µãƒ¼ãƒãƒ¼ã®ã€ŒVoidControllerã€ã«æ¥ç¶šï¼
      // ã“ã“ãŒé€£å‹•ã®ã‚­ãƒ¢ã§ã™
      const eventSource = new EventSource('/api/void-start');

      // 3. ãƒ‡ãƒ¼ã‚¿ãŒå±ŠããŸã³ã«å‹•ãå‡¦ç†
      eventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);

          // é€²æ—ãƒãƒ¼æ›´æ–°
          progressBar.style.width = data.percent + '%';
          progressBar.innerText = data.percent + '%';

          // ãƒ­ã‚°ãŒã‚ã‚Œã°è¡¨ç¤º
          if (data.message) {
              const logLine = document.createElement('div');
              logLine.innerText = `> ${data.message}`;
              logArea.appendChild(logLine);
              logArea.scrollTop = logArea.scrollHeight; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          }

          // å®Œäº†æ™‚ã®å‡¦ç†
          if (data.percent >= 100) {
              eventSource.close(); // é€šä¿¡åˆ‡æ–­
              btn.disabled = false;
              btn.innerText = "ã‚‚ã†ä¸€åº¦ã‚„ã‚‹";
              progressBar.classList.remove('bg-info');
              progressBar.classList.add('bg-success'); // ç·‘è‰²ã«ã™ã‚‹

              const endLog = document.createElement('div');
              endLog.innerText = `[SYSTEM] Process Completed Successfully.`;
              endLog.style.color = 'cyan';
              logArea.appendChild(endLog);
              logArea.scrollTop = logArea.scrollHeight;
          }
      };

      // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
      eventSource.onerror = function() {
          eventSource.close();
          btn.disabled = false;
          btn.innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
          const errLog = document.createElement('div');
          errLog.innerText = `[ERROR] Connection lost.`;
          errLog.style.color = 'red';
          logArea.appendChild(errLog);
      };
  }
</script>

</body>
</html>